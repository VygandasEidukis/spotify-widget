<!DOCTYPE html>
<html lang="en">


<head>
    <meta charset="UTF-8">
    <title>Spotify Widget Login</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>



<body class="min-h-screen flex items-center justify-center bg-gradient-to-br from-green-50 via-white to-blue-50">
    <div class="w-full max-w-md p-8 bg-white/90 rounded-2xl shadow-xl border border-gray-100 backdrop-blur-md">
        <div class="flex flex-col items-center mb-6">
            <div class="w-14 h-14 rounded-full bg-gradient-to-br from-green-400 to-blue-500 flex items-center justify-center mb-2 shadow-md">
                <svg viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-8 h-8"><circle cx="20" cy="20" r="20" fill="#1DB954"/><path d="M12 25c5-2 11-2 16 0" stroke="#fff" stroke-width="2.5" stroke-linecap="round"/><path d="M14 20c4-1.5 8-1.5 12 0" stroke="#fff" stroke-width="2" stroke-linecap="round"/><path d="M16 16c2.5-.5 5-.5 7.5 0" stroke="#fff" stroke-width="1.5" stroke-linecap="round"/></svg>
            </div>
            <h1 class="text-2xl font-bold text-gray-800 tracking-tight">Spotify Login</h1>
        </div>
        <div id="main-content">
            <p id="authenticating-msg" class="text-gray-700 text-center mb-4 animate-pulse">Authenticating with Spotify…</p>
            <div id="success-container" style="display:none">
                <div class="flex flex-col items-center mb-3">
                    <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center mb-2">
                        <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>
                    </div>
                    <p class="text-green-700 text-center text-lg font-semibold mb-1">Login succeeded!</p>
                </div>
                <div class="mb-2">
                    <label for="b64input" class="block text-gray-600 text-sm mb-1">Step 1: Copy your token data</label>
                    <div class="flex gap-2 mb-2">
                        <input id="b64input" type="text" value="" readonly class="flex-1 px-2 py-1 border border-gray-300 rounded bg-gray-100 text-xs text-gray-800 select-all" />
                        <button id="copy-btn" class="px-3 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700 transition">Copy</button>
                    </div>
                </div>
                <div class="mb-2">
                    <label class="block text-gray-600 text-sm mb-1">Step 2: Paste it into the widget settings</label>
                </div>
                <details class="mb-2">
                    <summary class="cursor-pointer text-xs text-gray-400 hover:text-gray-600">Show raw token details</summary>
                    <pre id="json-output" class="bg-gray-100 rounded p-2 text-xs text-gray-700 overflow-x-auto mt-1"></pre>
                </details>
            </div>
        </div>
    </div>

    <script>
        var redirectUri = 'https://vygandaseidukis.github.io/spotify-widget/callback';

        if (isLocalhost()) {
            redirectUri = 'http://127.0.0.1:5500/callback.html';
        }

        function isLocalhost() {
            return window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';;
        }

        async function exchangeCode(code, verifier, clientId) {

            const params = new URLSearchParams({
                grant_type: 'authorization_code',
                code,
                redirect_uri: redirectUri,
                client_id: clientId,
                code_verifier: verifier
            });

            const resp = await fetch('https://accounts.spotify.com/api/token', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: params.toString()
            });

            const data = await resp.json();
            localStorage.clear();
            if (data.access_token) {
                const jsonStr = JSON.stringify(data);
                const base64 = btoa(unescape(encodeURIComponent(jsonStr)));
                document.getElementById('authenticating-msg').style.display = 'none';
                document.getElementById('success-container').style.display = '';
                document.getElementById('b64input').value = base64;
                document.getElementById('json-output').textContent = jsonStr;
                $('#copy-btn').on('click', function () {
                    $('#b64input')[0].select();
                    document.execCommand('copy');
                });
            } else {
                document.body.innerHTML = `<p>❌ Error retrieving token</p><pre>${JSON.stringify(data)}</pre>`;
            }
        }

        const params = new URLSearchParams(window.location.search);
        const code = params.get('code');
        const state = params.get('state');
        const storedState = localStorage.getItem('spotify_auth_state');
        const verifier = localStorage.getItem('spotify_code_verifier');
        const clientId = localStorage.getItem('spotify_client_id');

        if (state !== storedState) {
            document.body.innerHTML = '<p>❌ Invalid state; possible CSRF attack.</p>';
        } else if (code && verifier && clientId) {
            exchangeCode(code, verifier, clientId);
        } else {
            document.body.innerHTML = '<p>❌ Missing code, state, or verifier.</p>';
        }
    </script>
</body>

</html>