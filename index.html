<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Spotify Login with PKCE</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
</head>
<body>
  <label>Spotify Client ID:</label><br>
  <input type="text" id="client-id" placeholder="Paste your Client ID"><br><br>
  <button id="login">Login with Spotify</button>

  <script>
    var redirectUri = 'https://vygandaseidukis.github.io/spotify-widget/callback';
    const scopes = 'user-read-playback-state user-read-currently-playing';

    if (isLocalhost()) {
      redirectUri = 'http://127.0.0.1:5500/callback.html';
    }

    function isLocalhost()
    {
        return window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';;
    }

    function generateRandomString(length) {
      const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      const array = crypto.getRandomValues(new Uint8Array(length));
      return Array.from(array).map(x => possible[x % possible.length]).join('');
    }

    async function sha256(buffer) {
      return await crypto.subtle.digest('SHA-256', buffer);
    }

    function base64urlEncode(buffer) {
      return btoa(String.fromCharCode(...new Uint8Array(buffer)))
        .replace(/=/g, '').replace(/\+/g, '-').replace(/\//g, '_');
    }

    async function generateCodeChallenge(verifier) {
      const encoder = new TextEncoder();
      const data = encoder.encode(verifier);
      const digest = await sha256(data);
      return base64urlEncode(digest);
    }

    $('#login').on('click', async () => {
      const clientId = $('#client-id').val().trim();
      if (!clientId) return alert('Please enter your Client ID');

      const codeVerifier = generateRandomString(64);
      const codeChallenge = await generateCodeChallenge(codeVerifier);
      const state = generateRandomString(16);

      localStorage.setItem('spotify_code_verifier', codeVerifier);
      localStorage.setItem('spotify_auth_state', state);
      localStorage.setItem('spotify_client_id', clientId);

      const params = new URLSearchParams({
        response_type: 'code',
        client_id: clientId,
        scope: scopes,
        redirect_uri: redirectUri,
        state: state,
        code_challenge_method: 'S256',
        code_challenge: codeChallenge
      });

      const authUrl = new URL("https://accounts.spotify.com/authorize")
      authUrl.search = new URLSearchParams(params).toString();
      window.location.href = authUrl.toString();
    });
  </script>
</body>
</html>
